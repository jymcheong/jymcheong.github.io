
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://jym.sg/mental%20models/Code%20Execution/">
      
      
        <link rel="prev" href="../Attack%20Life%20Cycle/">
      
      
        <link rel="next" href="../Tactics%20Techniques%20%26%20Procedures/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.29">
    
    
      
        <title>Code Execution - simple as 1, 2 and 3 - jym.sg</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.76a95c52.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-W27KNWVLVP"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-W27KNWVLVP",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-W27KNWVLVP",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="red" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#code-execution-simple-as-1-2-and-3" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="jym.sg" class="md-header__button md-logo" aria-label="jym.sg" data-md-component="logo">
      
  <img src="../../assets/logo.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            jym.sg
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Code Execution - simple as 1, 2 and 3
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../About%20Jym/" class="md-tabs__link">
        
  
    
  
  About Jym

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../blog/" class="md-tabs__link">
          
  
  Blog

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../Attack%20Life%20Cycle/" class="md-tabs__link">
          
  
  Mental models

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="jym.sg" class="md-nav__button md-logo" aria-label="jym.sg" data-md-component="logo">
      
  <img src="../../assets/logo.svg" alt="logo">

    </a>
    jym.sg
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../About%20Jym/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    About Jym
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Blog
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Blog
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../blog/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Latest
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Archive
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            Archive
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../blog/archive/2024/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../blog/archive/2021/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2021
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_3" >
        
          
          <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Categories
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            Categories
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../blog/category/attack-life-cycle/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Attack Life Cycle
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../blog/category/dotnet/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DotNet
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../blog/category/mental-models/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Mental models
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../blog/category/zerotier/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Zerotier
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../blog/category/graph-db/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    graph-db
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../blog/category/memgraph/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    memgraph
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../blog/category/orientdb/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    orientdb
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../blog/category/under-dogs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    under-dogs
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Mental models
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Mental models
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Attack%20Life%20Cycle/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Attack Life Cycle
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Code Execution - simple as 1, 2 and 3
  </span>
  

      </a>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Tactics%20Techniques%20%26%20Procedures/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tactics Techniques & Procedures
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="code-execution-simple-as-1-2-and-3">Code Execution -  simple as 1, 2 and 3</h1>
<p>How this model came to be...</p>
<p>Back then, I led a small Test &amp; Evaluation team (around 201X). We were testing out different up-coming cyber security products, like EDR (e.g. Carbon Black), malware sandboxes (e.g. FireEye)... The keyword that always appeared when evaluating such products is MALWARE; the whole point of <strong><em>mal</em></strong>icious soft<strong><em>ware</em></strong> is to execute arbitrary codes.</p>
<p>We looked at various public malware repositories, public &amp; commericial tools. As we reviewed the samples, we noticed some were PDFs, MS Office documents, and Active-Contents files that had embedded scripting. </p>
<blockquote>
<p>Malicious Code-Execution is NOT restricted to compiled executables.</p>
</blockquote>
<p>We noticed some patterns:</p>
<ol>
<li>A <em>new</em> PE file written to disk that <strong>wasn't in the target in the first place</strong>, then someone or something executes it...</li>
<li>Content based but Non-PEs files that may run malicious scripting with PDF (javascript) or a MS Office document (vba) &amp; various formats </li>
<li>Run an exploit tool (like Eternal Blue exploit CVE-2022-46869) that triggers a vulnerable service for remote arbitrary code execution (e.g. shellcodes), which in turn runs 1 or 2 (e.g. cmd / powershell scripting)</li>
</ol>
<blockquote>
<p>As a team lead, I concluded &amp; explained to my engineers that a pragmatic mental model has better operational utility than memorizing some malware taxonomy or attempt to enumerate all "bad" files or techniques under the sun... </p>
</blockquote>
<h1 id="the-three-types-model">The Three Types Model</h1>
<h2 id="type-1-new-file-execution">Type 1: New File Execution</h2>
<p><strong>Write</strong> a new PE file to disk and execute it (the classic write-&amp;-run "malware" approach).</p>
<h2 id="type-2-living-off-the-land">Type 2: Living Off The Land</h2>
<p><strong>Abuse</strong> legitimate system tools and scripting (PowerShell, VBA, JavaScript) with (e.g. there's DLL but it never touch the disk, all in memory) or without new executables.</p>
<h2 id="type-3-exploit-driven">Type 3: Exploit-Driven</h2>
<p><strong>Exploit</strong> vulnerabilities for arbitrary code execution, which chains into Type 1 or 2. Exploits that gained marketing/marketable names like Log4Shell, EternalBlue, etc, are typically Type 3.</p>
<h2 id="key-insights">Key Insights</h2>
<ul>
<li>Types 1 &amp; 2 abuse OS features (can't be patched, but at best hardened). </li>
<li>Type 3 exploits bugs (should be fixed with updates).<blockquote>
<p><em>This model is not Windows specific...</em> First two types are very reliable across different OS variants but Type 3 tend to be version specific.</p>
</blockquote>
</li>
</ul>
<p>There are finer aspects within this model beyond just Feature vs Bug:</p>
<ul>
<li>Fore vs Background launch</li>
<li>Before vs After Logon session</li>
<li>Egress &amp; Cross-Process activities</li>
<li>Privilege sequence</li>
</ul>
<p>All of these aspects are related to analytics, but it really just boils down to how we ask forensical questions.</p>
<h3 id="fore-vs-background-process">Fore vs background process</h3>
<blockquote>
<p>"Process" refers to the running memory instance of a program stored on disk.</p>
</blockquote>
<ul>
<li>Most sneaky backdoors are background processes within user touch-points for obvious reasons.</li>
<li>Most user-zone infiltrations tend to involve users' interactions or involvement e.g. email phishing.</li>
<li>Server side infiltration however could be a chain of background processes, starting from a vulnerable listening process, triggered to download &amp; run malicious codes.</li>
<li>Beyond parent-child process relationship, there's analytical value in tracking the transition from foreground to background spawning e.g. a foreground MS Office process spawned a background powershell process.</li>
<li>Play a role in discerning remote attack from insider actions for critical infrastructure environment, especially when we are able to track at both OS &amp; secure KVM level (e.g. session recording).</li>
</ul>
<blockquote>
<p>This process attribute is unfortunately not native to Windows, unlike Linux (e.g. tty, SessionID) &amp; MacOS that have fields in audit logs to infer whether it is a back/foreground process. We had to engineer it ourselves for Windows.</p>
</blockquote>
<h3 id="before-vs-after-logon-session">Before vs After Logon Session</h3>
<blockquote>
<p>Timing &amp; sequence matter. For instance...</p>
</blockquote>
<ul>
<li>A vulnerable server with Log4j listens on an exposed port, attacker sends it a payload that triggers a string of all background processes without anyone signing into the server...</li>
<li>Windows Sticky Keys backdoor launches a SYSTEM cmd.exe <em>before</em> any valid user logon.</li>
<li>A email phishing victim, can only be a victim after he or she logon &amp; interacts with some malicious contents that seems normal but runs abnormal hidden processes...</li>
</ul>
<p>We can contrast &amp; visualize all that like this:
<img alt="" src="../../assets/fore-background.png" /></p>
<h3 id="cross-process-egress-activities">Cross-Process &amp; Egress Activities</h3>
<p>While (Fore vs Background) + (Before vs After Logon) can characterise a set of process sequence like payload delivery or exercising a backdoor, Cross-Process &amp; Egress activities let us zoom into what's next for that sequence w.r.t TTP or Tactics (<em>the boxes below</em>, WHAT), Techniques (<em>specific &amp; numerous methods related to each box</em>, HOW) &amp; Procedures (<em>WHEN to do WHAT</em> as visualized in a graph):</p>
<p><img alt="" src="../../assets/egressNcrossProcess.png" /></p>
<ul>
<li>The red lines of Code-Execution to <code>Report to C2...</code> &amp; <code>Internal Reconn.</code> needs network access.</li>
<li>The orange lines tend to require access across process's memory, for instance the famous <code>Pass-the-Hash</code> problem in Windows such that offensive tools access LSASS.exe process memory to dump password hashes.</li>
<li>Many advanced in-memory techniques need cross-process access...</li>
</ul>
<blockquote>
<p>There are so many techniques &amp; why just focus on this two activities?</p>
</blockquote>
<ol>
<li>Initial Code-Execution tend to be multi-staged &amp; network access is required.</li>
<li>Even if it shifts towards the trend of hiding within images, legit content files etc, it will still have to call-back to C2.</li>
<li>Most if not all advanced in-memory techniques require cross-process access, it's inevitable.</li>
</ol>
<p>We will revisit these 3 points again in the last section.</p>
<h3 id="privilege-sequence">Privilege Sequence</h3>
<blockquote>
<p>Mostly to spot privilege escalations...</p>
</blockquote>
<h1 id="beyond-categorization">Beyond Categorization</h1>
<blockquote>
<p>Use the mental model to evaluate threat reports &amp; different types of technical controls or products.</p>
</blockquote>
<p>We started analyzing controls w.r.t various offensive techniques grouped by these three Code-Execution types. </p>
<h2 id="defense-coverage-matrix">Defense Coverage Matrix</h2>
<table>
<thead>
<tr>
<th><strong>Endpoint Controls</strong></th>
<th><strong>Type 1: Write New PE File to execute</strong></th>
<th><strong>Type 2: Living Off The Land</strong></th>
<th><strong>Type 3: Exploit-Driven</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Anti-Virus (AV)</strong></td>
<td>⚠ Blocks known bad with signatures but malware mutation is free &amp; voluminous</td>
<td>✗ Weak (fileless, in-memory)</td>
<td>✗ Useless (0-day exploits)</td>
</tr>
<tr>
<td><strong>Application Control (default deny)</strong></td>
<td>✓ Blocks (allow-list)</td>
<td>✗ Bypassed (DLL side-loading, scripting &amp; legit commands abuses)</td>
<td>✗ No protection</td>
</tr>
<tr>
<td><strong>Driver-based EDR</strong></td>
<td>⚠ Monitors behavior (evaded by direct syscalls, unhooking)</td>
<td>⚠ Disarmed by signed drivers, OS tools...</td>
<td>⚠ Monitors behavior (partial visibility)</td>
</tr>
<tr>
<td><strong>Ring-fencing with Moving-Target agents</strong></td>
<td>✓ Deny written PE (on disks) w/o easy loop-holes &amp; tedium of allow-list management</td>
<td>✓ Disrupts C2, payload delivery &amp; lateral movement (e.g. fileless)</td>
<td>✓ Disrupts C2, payload delivery &amp; lateral movement</td>
</tr>
</tbody>
</table>
<h2 id="anti-virus-bad-listing">Anti-Virus (Bad-listing)</h2>
<p>The problems with traditional signature-based Anti-Virus...</p>
<ul>
<li>Mutating &amp; evasions are essentially free thanks to numerous public repositories &amp; tools.</li>
<li>Updating signatures is a continuous process that many environments can't achieve (e.g. OT networks that are adverse to changes and updates).</li>
<li>Not effective against Type 2 techniques.</li>
<li>Totally useless against 0-day exploits (Type 3).</li>
</ul>
<blockquote>
<p>Contemporary antivirus companies mostly pivoted to behavior-based detection that identify threats based on actions and system modifications rather than relying solely on file signatures, enabling detection of fileless and non-PE attack vectors.</p>
</blockquote>
<p>But the general approach still revolves around offensive behaviors &amp; signatures. <em>The next type of controls focuses on allow-listing...</em></p>
<h2 id="app-control-good-listing">App Control (Good-listing)</h2>
<p>Application-Control in principle works well to deny Type 1 since malicious PE files are part of an potentially infinite set. But there are numerous loop-holes in practice... </p>
<ul>
<li>DLL checking is turned off as it is very resource intensive.</li>
<li>Plenty of DLL loading methods which are <em>mostly Type 2 methods to get around App Control reliably</em>.</li>
<li>Managing allowed-lists in certain environments can be challenging.</li>
<li>Going file-less (using Type 2 or 3 techniques) can easily reuse malicious DLL but loading directly to memory without writing to disks</li>
</ul>
<blockquote>
<p>Microsoft's implementations are fragmented. Software Restriction Policy was officially deprecated in 2020 and completely stopped functioning in Windows 11 22H2 fresh installations, though upgraded systems retained limited functionality. Microsoft explicitly recommended transitioning to AppLocker or Windows Defender Application Control (WDAC) as replacements.</p>
</blockquote>
<h2 id="edr-only-as-secure-as-windows-inherent-vulnerabilities">EDR (only as secure as Windows' inherent vulnerabilities)</h2>
<p>EDR (along with all host controls) security is only as strong as Windows' inherent vulnerabilities allow:</p>
<ul>
<li>Type 1 malware can bypass monitoring hooks through direct syscalls, kernel callbacks evasion, and API unhooking.</li>
<li>A recent example of Type 2 technique is <code>EDR-Freeze</code> disclosed in September 2025 by security researcher TwoSevenOneThree (Zero Salarium) that suspends EDR and antivirus processes indefinitely by abusing Windows Error Reporting (WER) system components. </li>
<li>Type 3 methods like 0-day exploits (e.g. UEFI rootkit BlackLotus) may achieve execution before EDR or totally disarm EDR drivers.</li>
</ul>
<blockquote>
<p>When the EDR missed the malicious code that disabled it, that endpoint visibility/protection is mostly compromised. Attackers still get around anti-tampering mechanisms like Early Launch Anti-Malware (ELAM) and Kernel-Level protections, by abusing many vulnerable but signed drivers that are out there. Bear in mind that not all EDR solutions are ELAM certified. </p>
</blockquote>
<p>This isn't about how well EDR detects threats. <em>It's about how well the product stays useful despite the underlying OS flaws</em>. This issue isn't unique to EDR, ALL Windows host controls are susceptible to attacks.</p>
<blockquote>
<p>Adversaries are well funded to get hold of such products to figure out ways to disarm &amp; evade.</p>
</blockquote>
<h2 id="ring-fencing-disrupt-the-vectors-moving-target-protect-the-product">Ring-fencing (Disrupt the vectors) + Moving-Target (Protect the product)</h2>
<p>By breaking down Code-Execution into 3 simple bins, it helped us identify these factors:</p>
<ol>
<li>Most offensive codes tend to be packaged into compiled PE files, not coincidence that ransomware are mostly PEs.</li>
<li>Compared to PEs, offensive scripts are easier to reverse engineer.</li>
<li>Blocking PE files delivery is common, most corporate proxies can &amp; will, even free email services do that. </li>
<li>Type 2 techniques are reliable for getting more compiled codes into the target, despite the network layer controls mentioned above.</li>
<li>Type 2 &amp; 3 are also useful for server-side remote code execution (e.g. SQLi &amp; Log4J exploits). </li>
</ol>
<p>Most if not all INITIAL Code-Executions are based on some multi-staged that <strong><em>WILL eventually involve network &amp; cross-process access</em></strong>. </p>
<blockquote>
<p>Think of it as a multi-staged rocket launch. It may seem powerful but it is actually quite fragile. If one of the stages fails, the whole launch fails. </p>
</blockquote>
<p>The last section further explains ring-fencing that disrupts malicious network &amp; cross-process access.</p>
<h3 id="how-to-ring-fence">How to Ring-Fence?</h3>
<p><img alt="" src="../../assets/ringFence.png" /></p>
<p>It is basically dual-layer barriers to disrupt attacks, <em>but won't affect legimate processes</em>. Let's use this 3-type model approach to divide &amp; conquer the problem.</p>
<h4 id="type-1-denied-by-app-control"><em>Type 1</em> denied by App Control:</h4>
<ul>
<li>Malicious PE forms the bulk of the problem.</li>
<li>Application Control is useful since it eliminates tracking of an infinite bad-list, BUT... </li>
<li>how do we deal with loop-holes like DLL loading by Type 2 &amp; 3 techniques?</li>
<li>tedium of maintaining lists?</li>
</ul>
<p>Two hygiene factors that are conducive to effective App Control, <strong><em>without maintaining allow-lists</em></strong>: </p>
<ol>
<li>Users should be in <code>Standard Users</code> for your the bulk of users. </li>
<li>Minimize the total number of Local admins (or eliminate if possible) within your client-zones. </li>
<li>Avoid deploying programs in user-writable folders &amp; have executable files writable by <code>Standard Users</code>.</li>
</ol>
<blockquote>
<p><em>When users can write/change those files, so can attacker's malicious processes, which tend to run in user's context during initial intrusion.</em> When that happens:</p>
</blockquote>
<ul>
<li>All files created by Standard Users' processes, are owned by the user/victim.</li>
<li>Conversely, all centrally deployed files are typically owned by <code>SYSTEM</code>, <code>TrustedInstaller</code> &amp; <code>Administrators Group</code>. E.g. Programs that are installed in <code>C:\Program Files...</code></li>
</ul>
<p>The exception to default file-ownership behavior is under certain UAC setting for Local Admin &amp; Domain Admin, where written files are immediately owned by <code>Administrators Group</code>.</p>
<blockquote>
<p>This simple file ownership distinction can deny ALL written PE files written under non-privileged context, including DLL loading techniques because a non-privileged user-process cannot change file ownership to <code>SYSTEM</code>, <code>TrustedInstaller</code> or <code>Administrators Group</code>.</p>
</blockquote>
<p>It is therefore possible to achieve low cost &amp; effort Application Control, simply with native NTFS ACLs. I covered in detail with my <a href="https://github.com/jymcheong/ETW-tutorialSet/tree/main/ETW%20Helper%20Class">ETW series</a> here. That sharing also includes C# source codes to explain how file-ownership control can be enforced.</p>
<h4 id="type-2-3-disrupted-by-granular-process-profiling"><em>Type 2 &amp; 3</em> disrupted by granular process profiling:</h4>
<p>We know that chasing "bad" or offensive techniques is a challenge since it is an infinite set like the one shown on the right of the figure:
<img alt="" src="../../assets/infiniteBad.png" /></p>
<p>We also know that the set of network &amp; cross-process accessing processes are always finite in any endpoints. The intersection of such process that can be either abused or exploited is even smaller. This may look too abstract, let's look at a real world concrete example:</p>
<p><img alt="" src="../../assets/githubC2.png" /></p>
<p>This is one of those hide-and-seek games that criminals employ to abuse GitHub as a C2 center. When law enforcement takes down a specific GitHub repository, attackers quickly set up another one. Let's focus on the green box; no matter which repository that is hosting, this is the point where a victim clicks the LNK file that triggers the download of MSHTA.exe, which then downloads more files.</p>
<blockquote>
<p>Using granular process profiling, we can effectively isolate the network and cross-process access by disrupting the new process profile that deviates from our baseline. </p>
</blockquote>
<p>The basic host firewall rules are not enough because they usually only look at the destination or the program path. In this case, MSHTA.exe is a native system program. There are many other system programs that we might not want to block network access. By using the ideas from Application Control, we can create a detailed profile of the processes that are leaving the network and accessing memory across different processes. </p>
<blockquote>
<p>My <a href="https://github.com/jymcheong/ETW-tutorialSet/tree/main/ETW%20Helper%20Class">ETW series</a> delves deeper into this topic and provides code-level explanations of how we can achieve this granular profiling.</p>
</blockquote>
<h3 id="what-is-moving-target-why-it-matters">What is Moving-Target &amp; Why it matters?</h3>
<p>Remember the CrowdStrike incident? A single mistake with a specific low-level resource file consumed by a kernel driver caused almost a global outage.</p>
<p>While causing an outage that is hard to recover may not be beneficial for criminals at large, abusing Windows' inherent weaknesses by exploiting vulnerable drivers to disable EDR, AV, or App Control can be quite useful. This phenomenon is known as Bring-Your-Own-Vulnerable Driver (BYOVD).</p>
<p>In the past, there were some barrier to entry for such disabling of host control as it still required some skills. But it has now become commoditized &amp; accessible to low to mid skilled criminals. </p>
<blockquote>
<p>The core issue is that most products are very static in nature &amp; waiting to be tampered. Despite some anti-tampering, the underlying OS is still vulnerable to attacks.</p>
</blockquote>
<p>Moving-Target agents adopt a fight fire with fire approach, by ditching traditional kernel drivers for light weight portable agents that are unique per deployment. Doing so realise the favorable characteristics stated in the last row of the earlier Defensive Coverage Matrix.</p>
<p>The benefits of Ring-fencing with Moving Target agents are:</p>
<ul>
<li>Long term defensive value suitable for protecting critical infrastructure assets that are adverse to constant driver or related signatures updates.</li>
<li>Disrupts new malware &amp; initial intrusion callbacks to C2 &amp; lateral movement without upkeeping of signatures.</li>
<li>Even under detect-only mode, it has much better signal-to-noise ratio than conventional detection engineering that usually ends up costly &amp; noisy.</li>
</ul>
<h3 id="why-theres-still-security-by-obscurity">Why there's still security by obscurity?</h3>
<p>While moving-target host agents may appear to rely on security by obscurity, they actually gain defensive strength from unpredictability. Most commercial off-the-shelf (COTS) endpoint products expose static attack surfaces—unchanging drivers, predictable configurations, and stable process behaviors—that adversaries can study and exploit over time. </p>
<p>By contrast, moving-target agents shift these parameters dynamically, denying attackers a fixed point of reference. Kerckhoffs’s principle applies to cryptographic systems, not to adaptive defensive architectures; misapplying it here overlooks the practical longevity that controlled uncertainty can provide in real-world defense.</p>
<blockquote>
<p>There are already more host controls that are based on Ring-Fencing approaches, hopefully we can see more that cannot be easily disarmed by abusing Windows inherent weaknesses.</p>
</blockquote>









  




                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.expand", "navigation.tabs"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.fe8b6f2b.min.js"></script>
      
    
  </body>
</html>